<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <script>
        // Hack to force high resolution to try to pick the main camera on mobile
        // instead of the wide-angle camera which is often default for "environment"
        const origGetUserMedia = navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);
        navigator.mediaDevices.getUserMedia = function(constraints) {
            if (constraints.video && constraints.video.facingMode === 'environment') {
                // Adding width/height constraints often forces the main camera
                constraints.video.width = { min: 1280, ideal: 1920, max: 2560 };
                constraints.video.height = { min: 720, ideal: 1080, max: 1440 };
                constraints.video.frameRate = { ideal: 60 };
            }
            return origGetUserMedia(constraints);
        };

        // Component to set the aspect ratio of the image to match its natural dimensions
        AFRAME.registerComponent('fix-aspect-ratio', {
            init: function () {
                const el = this.el;
                const src = el.getAttribute('src');
                // Handle both selector and direct url
                const img = document.querySelector(src);
                
                if (img) {
                    if (img.complete) {
                        this.setRatio(img);
                    } else {
                        img.onload = () => {
                            this.setRatio(img);
                        };
                    }
                }
            },
            setRatio: function (img) {
                if (img.naturalWidth === 0) return;
                const ratio = img.naturalHeight / img.naturalWidth;
                this.el.setAttribute('height', ratio);
                this.el.setAttribute('width', '1');
            }
        });
    </script>

    <style>
        /* This removes the default scrollbars and ensures the scene is full-screen */
        body { margin: 0; }
    </style>
</head>
<body>
    <a-scene mindar-image="imageTargetSrc: ./targets.mind;"
             color-space="sRGB"
             renderer="colorManagement: true, physicallyCorrectLights"
             vr-mode-ui="enabled: false"
             device-orientation-permission-ui="enabled: false">

        <a-assets>
            <img id="overlayImage" src="./display.webp" crossorigin="anonymous" />
        </a-assets>

        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <a-entity mindar-image-target="targetIndex: 0">
            <a-image src="#overlayImage" 
                     rotation="0 0 0" 
                     position="0 0 0" 
                     width="1" 
                     height="1"
                     fix-aspect-ratio>
            </a-image>
        </a-entity>
    </a-scene>
</body>
</html>